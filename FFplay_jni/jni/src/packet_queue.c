#include <string.h>#include <jni.h>#include <android/log.h>#include "packet_queue.h"#define  D(x...)  __android_log_print(ANDROID_LOG_DEBUG,"packet_queue",x)void packet_queue_init(PacketQueue *q){	memset(q, 0, sizeof(PacketQueue));//	q->mutex = SDL_CreateMutex();//	q->cond = SDL_CreateCond();}int packet_queue_put(PacketQueue *q, AVPacket *pkt){	AVPacketList *pkt1;//	D("pkt data pointer is %p\n", pkt->data);	if (av_dup_packet(pkt) < 0)	{		return -1;	}	pkt1 = (AVPacketList*) av_malloc(sizeof(AVPacketList));	if (!pkt1)		return -1;	pkt1->pkt = *pkt;	pkt1->next = NULL;//	SDL_LockMutex(q->mutex);	if (!q->last_pkt)		q->first_pkt = pkt1;	else		q->last_pkt->next = pkt1;	q->last_pkt = pkt1;	q->nb_packets++;	q->size += pkt1->pkt.size;//	SDL_CondSignal(q->cond);////	SDL_UnlockMutex(q->mutex);	return 0;}int packet_queue_get(PacketQueue *q, AVPacket *pkt, int block){	AVPacketList *pkt1;	int ret;//	SDL_LockMutex(q->mutex);	for (;;)	{		if (q->abort_request)		{			ret = -1;			break;		}		pkt1 = q->first_pkt;		if (pkt1)		{			q->first_pkt = pkt1->next;			if (!q->first_pkt)				q->last_pkt = NULL;			q->nb_packets--;			q->size -= pkt1->pkt.size;			*pkt = pkt1->pkt;			av_free(pkt1);			ret = 1;			break;		}		else if (!block)		{			ret = 0;			break;		}		else		{//			SDL_CondWait(q->cond, q->mutex);		}	}//	SDL_UnlockMutex(q->mutex);	return ret;}void packet_queue_flush(PacketQueue *q){	AVPacketList *pkt, *pkt1;//    SDL_LockMutex(q->mutex);	for (pkt = q->first_pkt; pkt != NULL; pkt = pkt1)	{		pkt1 = pkt->next;		av_free_packet(&pkt->pkt);		av_freep(&pkt);	}	q->last_pkt = NULL;	q->first_pkt = NULL;	q->nb_packets = 0;	q->size = 0;//    SDL_UnlockMutex(q->mutex);}void packet_queue_end(PacketQueue *q){	packet_queue_flush(q);//    SDL_DestroyMutex(q->mutex);//    SDL_DestroyCond(q->cond);}void packet_queue_abort(PacketQueue *q){//    SDL_LockMutex(q->mutex);?	q->abort_request = 1;//    SDL_CondSignal(q->cond);////    SDL_UnlockMutex(q->mutex);}